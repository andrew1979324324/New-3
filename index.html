<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a73e8">
    <title>Lavoro Pro 2026 Cloud</title>

    <link rel="icon" type="image/png" href="https://i.ibb.co/0yCxc7hJ/logo.png">
    <link rel="apple-touch-icon" href="https://i.ibb.co/0yCxc7hJ/logo.png">

    <style>
        :root { --primary: #1a73e8; --success: #1d6f42; --danger: #d93025; --bg: #f0f2f5; }
        body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; text-align: center; background: var(--bg); color: #333; margin: 0; padding-bottom: 50px; }
        
        /* Header & Status */
        .app-header { background: var(--primary); color: white; padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; sticky: top; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2); position: sticky; top: 0; }
        .header-content { display: flex; align-items: center; gap: 12px; }
        .header-content img { height: 40px; width: 40px; border-radius: 8px; background: white; padding: 2px; }
        #sync-status { font-size: 11px; opacity: 0.9; }

        /* Calendar Grid */
        #calendar-container { max-width: 95%; margin: 15px auto; background: white; padding: 12px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        #week-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; font-weight: bold; margin-bottom: 10px; color: #5f6368; font-size: 0.7rem; }
        #calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        
        .day { background: #fff; border: 1px solid #eee; border-radius: 10px; cursor: pointer; min-height: 80px; display: flex; flex-direction: column; font-size: 10px; position: relative; transition: 0.2s; }
        .day.today { border: 2px solid var(--primary) !important; background: #e8f0fe; }
        .day-number { font-weight: bold; font-size: 13px; padding: 4px; background: rgba(0,0,0,0.02); border-bottom: 1px solid #f0f0f0; }
        .empty { background: transparent; border: none; }

        /* Modals */
        .modal { display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 420px; max-height: 85vh; background:white; z-index: 1000; padding: 20px; border-radius: 20px; box-shadow: 0 25px 50px rgba(0,0,0,0.3); text-align: left; overflow-y: auto; }
        
        /* Forms & Buttons */
        select, input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #dadce0; border-radius: 10px; font-size: 16px; box-sizing: border-box; }
        button { padding: 14px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%; margin: 5px 0; transition: 0.2s; }
        .btn-save { background: var(--primary); color: white; }
        .btn-close { background: #f1f3f4; color: #3c4043; }
        .btn-delete { background: #fce8e6; color: var(--danger); margin-top: 15px; }
        
        .loading-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; justify-content:center; align-items:center; flex-direction: column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay">
    <div class="spinner"></div>
    <b style="color:var(--primary)">Sincronizzazione...</b>
</div>

<div class="app-header">
    <div class="header-content">
        <img src="https://i.ibb.co/0yCxc7hJ/logo.png" alt="Logo">
        <div>
            <h1 style="margin:0; font-size:1.1rem;">Lavoro Pro 2026</h1>
            <div id="sync-status">Inizializzazione...</div>
        </div>
    </div>
    <button onclick="loadFromCloud()" style="width:40px; height:40px; border-radius:50%; background:rgba(255,255,255,0.2); color:white; padding:0;">üîÑ</button>
</div>

<div style="margin: 15px;">
    <select id="monthSelect" style="width: auto; border:none; font-weight:bold; color:var(--primary); background:transparent;"></select>
</div>

<div id="calendar-container">
    <div id="week-days"><div>Lun</div><div>Mar</div><div>Mer</div><div>Gio</div><div>Ven</div><div>Sab</div><div>Dom</div></div>
    <div id="calendar"></div>
</div>

<div style="padding: 10px 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
    <button class="btn-save" onclick="showSummary()">üìä Consuntivo</button>
    <button style="background:white; border:1px solid var(--primary); color:var(--primary);" onclick="showAnnualSummary()">üìà Stats</button>
</div>

<div id="formBox" class="modal">
    <h3 id="selectedDate" style="margin-top:0; color:var(--primary); border-bottom:1px solid #eee; padding-bottom:10px;"></h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <button style="background:#f1f3f4;" onclick="copyData()">üìã Copia</button>
        <button id="pasteBtn" style="background:#fff3e0; color:#e65100; display:none;" onclick="pasteData()">üì• Incolla</button>
    </div>
    
    <label>Societ√†</label><select id="client"></select>
    <label>Location</label><select id="location"></select>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div><label>Inizio</label><select id="startTime"></select></div>
        <div><label>Fine</label><select id="endTime"></select></div>
    </div>
    
    <label>Pausa pranzo</label>
    <select id="lunchBreak">
        <option value="si">S√¨ (9h soglia)</option>
        <option value="no">No (8h soglia)</option>
    </select>
    
    <div id="dayLiveRes" style="padding:12px; background:#e8f0fe; border-radius:10px; margin:15px 0; font-weight:bold; color:var(--primary); text-align:center;"></div>
    
    <button class="btn-save" onclick="saveData()">üíæ Salva nel Cloud</button>
    <button class="btn-close" onclick="closeAll()">Annulla</button>
    <button id="deleteBtn" class="btn-delete" onclick="deleteData()">üóëÔ∏è Elimina</button>
</div>

<div id="summaryBox" class="modal">
    <h3 style="color:var(--primary)">Consuntivo Mese</h3>
    <div id="summaryContent"></div>
    <button class="btn-save" style="background:var(--success)" onclick="exportCSV('tutti')">üíæ Esporta CSV</button>
    <button class="btn-close" onclick="closeAll()">Chiudi</button>
</div>

<div id="annualBox" class="modal">
    <h3 style="color:var(--primary)">Statistiche 2026</h3>
    <div id="annualContent"></div>
    <button class="btn-close" onclick="closeAll()">Chiudi</button>
</div>

<script>
const CLOUD_URL = "TUO_URL_SCRIPT_QUI"; // Inserisci il tuo URL Google Apps Script
const companies = ["Anteprima Video","Airone","Av Set","B-Nomio","Centro Pilota","Ciccarelli","Dafral Soundvision","De Simoni","Digital Network","DHS","F.A.R.E. Servizi","Gruppo Planet","HRC","Ifet","Livon","Lvs","Milani group","Mondialtecnica","Niutek","Onegroup","Sincronismi","Studiovisio","TCS 2000","Tecnoconference Roma","Tecnomeeting","Vms"];
const locations = ["Anantara","Angelicum","A. Roma Lifestyle","Acquario Romano","Auditorium P.d. Musica","Bernini Bristol","H. Massimo d'Azeglio","Cardo Roma","Chiostro Del Bramante","Don Giovanni (Praga)","Fao","Hotel Vanvitelli","Ergife Palace Hotel","Esperienza Europa","Eurostars Roma Aeterna","Fiera di Bologna","Hotel D. Camilla Savelli","H. Barcel√≤ Mantegna","H. Bulgari","H. Dei Mellini","H. Le Merdien Visconti","H. Parco de Principi","Hotel Plaza","Holiday Inn Rome","H. Rome Airport","H. Rome Eur La Lama","H. Nazionale","H. Ripa","Hotel Villa Pamphili","Boutique Calzavecchio","MOMEC","Nhow","Nh Centro","Nh Villa Carpegna","Nh Giustiniano","La Nuvola","Palazzo dell'INPS","Parlamento Europeo Italia","Rome Marriot P.H.","Rome Cavalieri","Salone delle Fontane","S. Rome P. De' Medici","StarHotels Metropole","Starhotels Excelsior (Bo)","StarHotels Michelangelo (Fi)","Spazio 900","Spazio Sette Libreria","The Hive Hotel","The Westin Warsaw","The Westin Excelsior Rome","The St. Regis Rome","The Space Cinema Moderno","Tempio di Adriano","Villa Miani","Studio Curtis","Villa Madama"];
const months = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];

let currentMonth = new Date().getMonth();
let currentYear = 2026;
let clipboard = null;

window.onload = () => {
    setupSelects();
    loadFromCloud();
};

function setupSelects() {
    const cSel = document.getElementById("client"), lSel = document.getElementById("location"), mSel = document.getElementById("monthSelect");
    const sSel = document.getElementById("startTime"), eSel = document.getElementById("endTime");

    companies.sort().forEach(c => cSel.add(new Option(c, c)));
    locations.sort().forEach(l => lSel.add(new Option(l, l)));
    months.forEach((m, i) => mSel.add(new Option(m, i)));
    
    mSel.value = currentMonth;
    mSel.onchange = renderCalendar;

    for(let h=0; h<24; h++) {
        ["00","30"].forEach(m => {
            let v = `${h.toString().padStart(2,'0')}:${m}`;
            sSel.add(new Option(v, v)); eSel.add(new Option(v, v));
        });
    }
    document.querySelectorAll('#startTime, #endTime, #lunchBreak').forEach(el => el.onchange = updateLiveRes);
}

// FORMATTAZIONE CHIAVE ISO (YYYY-MM-DD)
function formatDateKey(day) {
    const m = (currentMonth + 1).toString().padStart(2, '0');
    const d = day.toString().padStart(2, '0');
    return `${currentYear}-${m}-${d}`;
}

async function loadFromCloud() {
    toggleLoading(true);
    try {
        const response = await fetch(CLOUD_URL);
        const cloudData = await response.json();
        // Sincronizzazione intelligente: non cancella tutto se il cloud √® vuoto
        if (Object.keys(cloudData).length > 0) {
            Object.keys(localStorage).forEach(k => { if(k.startsWith("2026-")) localStorage.removeItem(k); });
            Object.keys(cloudData).forEach(k => localStorage.setItem(k, JSON.stringify(cloudData[k])));
        }
        document.getElementById('sync-status').innerText = "Sincronizzato ‚úÖ";
        renderCalendar();
    } catch (e) {
        document.getElementById('sync-status').innerText = "Modalit√† Offline üì∂";
    } finally { toggleLoading(false); }
}

async function syncToCloud() {
    toggleLoading(true);
    const allData = {};
    Object.keys(localStorage).forEach(k => { if(k.startsWith("2026-")) allData[k] = JSON.parse(localStorage.getItem(k)); });
    try {
        await fetch(CLOUD_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ action: "save", db: JSON.stringify(allData) })
        });
        document.getElementById('sync-status').innerText = "Salvato nel Cloud ‚òÅÔ∏è";
    } catch (e) {
        alert("Errore salvataggio Cloud. Dati salvati localmente.");
    } finally { toggleLoading(false); }
}

function getStats(start, end, lunch) {
    const s = new Date(`1970-01-01T${start}`), e = new Date(`1970-01-01T${end}`);
    let diff = (e - s) / (1000 * 60 * 60);
    if (diff < 0) diff += 24;
    const soglia = lunch === 'no' ? 8 : 9;
    const stra = Math.max(0, diff - soglia);
    const lordo = 250 + (stra * 25);
    return { stra, lordo, netto: lordo * 0.74 };
}

function renderCalendar() {
    const cal = document.getElementById("calendar"); cal.innerHTML = "";
    currentMonth = parseInt(document.getElementById("monthSelect").value);
    
    const firstDay = new Date(currentYear, currentMonth, 1).getDay();
    const offset = firstDay === 0 ? 6 : firstDay - 1;
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const oggiStr = new Date().toISOString().split('T')[0];

    for(let i=0; i<offset; i++) cal.appendChild(Object.assign(document.createElement("div"), {className: "day empty"}));
    
    for(let i=1; i<=daysInMonth; i++) {
        const key = formatDateKey(i);
        const data = JSON.parse(localStorage.getItem(key));
        const div = document.createElement("div");
        div.className = "day" + (key === oggiStr ? " today" : "");
        div.onclick = () => openDay(i);
        div.innerHTML = `<div class="day-number">${i}</div>`;
        
        if(data) {
            const color = getColor(data.client);
            div.style.borderLeft = `4px solid ${color.replace('85%','40%')}`;
            div.style.background = color;
            div.innerHTML += `<div style="padding:2px; font-weight:bold; overflow:hidden;">${data.client.substring(0,8)}</div>`;
        }
        cal.appendChild(div);
    }
}

function openDay(day) {
    const key = formatDateKey(day);
    const form = document.getElementById("formBox");
    form.style.display = "block";
    form.dataset.key = key;
    document.getElementById("selectedDate").innerText = `${day} ${months[currentMonth]} 2026`;
    
    const data = JSON.parse(localStorage.getItem(key));
    if(data) {
        document.getElementById("client").value = data.client;
        document.getElementById("location").value = data.location;
        document.getElementById("startTime").value = data.startTime;
        document.getElementById("endTime").value = data.endTime;
        document.getElementById("lunchBreak").value = data.lunchBreak || 'si';
        document.getElementById("deleteBtn").style.display = "block";
    } else {
        document.getElementById("startTime").value = "08:30";
        document.getElementById("endTime").value = "17:30";
        document.getElementById("deleteBtn").style.display = "none";
    }
    updateLiveRes();
}

function updateLiveRes() {
    const s = getStats(document.getElementById("startTime").value, document.getElementById("endTime").value, document.getElementById("lunchBreak").value);
    document.getElementById("dayLiveRes").innerText = `Lordo: ‚Ç¨${s.lordo.toFixed(2)} | Stra: ${s.stra.toFixed(1)}h`;
}

async function saveData() {
    const key = document.getElementById("formBox").dataset.key;
    const data = {
        client: document.getElementById("client").value, location: document.getElementById("location").value,
        startTime: document.getElementById("startTime").value, endTime: document.getElementById("endTime").value, lunchBreak: document.getElementById("lunchBreak").value
    };
    localStorage.setItem(key, JSON.stringify(data));
    await syncToCloud();
    closeAll(); renderCalendar();
}

async function deleteData() {
    if(confirm("Eliminare questa giornata?")) {
        localStorage.removeItem(document.getElementById("formBox").dataset.key);
        await syncToCloud();
        closeAll(); renderCalendar();
    }
}

function showSummary() {
    let html = "", grandTotal = 0;
    const dataByClient = {};
    for(let i=1; i<=31; i++) {
        const d = JSON.parse(localStorage.getItem(formatDateKey(i)));
        if(d) {
            if(!dataByClient[d.client]) dataByClient[d.client] = [];
            dataByClient[d.client].push({day: i, ...d});
        }
    }
    for(let client in dataByClient) {
        let sub = 0;
        html += `<div style="background:#f8f9fa; padding:10px; border-radius:8px; margin-top:10px; font-weight:bold; border-left:4px solid ${getColor(client)}">${client}</div><table style="width:100%; font-size:12px; border-collapse:collapse;">`;
        dataByClient[client].forEach(item => {
            const s = getStats(item.startTime, item.endTime, item.lunchBreak);
            html += `<tr style="border-bottom:1px solid #eee; height:30px;"><td>Giorno ${item.day}</td><td>${s.stra.toFixed(1)}h stra</td><td>‚Ç¨${s.lordo.toFixed(0)}</td></tr>`;
            sub += s.lordo;
        });
        html += `<tr style="font-weight:bold;"><td>TOTALE</td><td></td><td>‚Ç¨${sub.toFixed(2)}</td></tr></table>`;
        grandTotal += sub;
    }
    document.getElementById("summaryContent").innerHTML = html || "Nessun dato per questo mese.";
    document.getElementById("summaryBox").style.display = "block";
}

function showAnnualSummary() {
    let totalNetto = 0, totalGG = 0;
    Object.keys(localStorage).forEach(k => {
        if(k.startsWith("2026-")) {
            const d = JSON.parse(localStorage.getItem(k));
            const s = getStats(d.startTime, d.endTime, d.lunchBreak);
            totalNetto += s.netto; totalGG++;
        }
    });
    document.getElementById("annualContent").innerHTML = `
        <div style="background:#f8f9fa; padding:15px; border-radius:10px;">
            <p>Giornate lavorate: <b>${totalGG}</b></p>
            <p>Netto stimato: <b>‚Ç¨${totalNetto.toFixed(2)}</b></p>
        </div>`;
    document.getElementById("annualBox").style.display = "block";
}

function exportCSV(target) {
    let csv = "\ufeffSociet√†;Data;Location;Inizio;Fine;Straordinari;Lordo\n";
    for(let i=1; i<=31; i++) {
        const d = JSON.parse(localStorage.getItem(formatDateKey(i)));
        if(d) {
            const s = getStats(d.startTime, d.endTime, d.lunchBreak);
            csv += `${d.client};${i}/${currentMonth+1}/2026;${d.location};${d.startTime};${d.endTime};${s.stra.toFixed(1)};${s.lordo.toFixed(2)}\n`;
        }
    }
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8'});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `Lavoro_2026_${months[currentMonth]}.csv`;
    link.click();
}

function getColor(name) {
    let hash = 0; for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
    return `hsl(${Math.abs(hash) % 360}, 75%, 90%)`;
}
function toggleLoading(show) { document.getElementById("loading").style.display = show ? "flex" : "none"; }
function closeAll() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); }
function copyData() { clipboard = { client: document.getElementById("client").value, location: document.getElementById("location").value, startTime: document.getElementById("startTime").value, endTime: document.getElementById("endTime").value, lunchBreak: document.getElementById("lunchBreak").value }; document.getElementById("pasteBtn").style.display = "block"; }
function pasteData() { if(clipboard) { document.getElementById("client").value = clipboard.client; document.getElementById("location").value = clipboard.location; document.getElementById("startTime").value = clipboard.startTime; document.getElementById("endTime").value = clipboard.endTime; document.getElementById("lunchBreak").value = clipboard.lunchBreak; updateLiveRes(); } }
</script>
</body>
</html>
